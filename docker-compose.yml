# docker-compose.yml
version: '3.8'

services:
  # Servicio para la base de datos PostgreSQL
  db:
    image: postgres:17.0-bookworm
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-Password#1234}
      POSTGRES_DB: ${POSTGRES_DB:-synthetic_data}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql

  # Servicio para la aplicación de Python
  app:
    # Construye la imagen usando el Dockerfile del directorio actual.
    build: .
    container_name: python_app
    restart: always
    # Mapea el puerto 8501 del contenedor al 8501 de tu máquina.
    ports:
      - "8501:8501"
    # Monta el código local en el contenedor para ver cambios en tiempo real.
    volumes:
      - .:/app
      - ./data:/app/data
    # Pasa variables de entorno a la aplicación.
    environment:
      # La URL para conectarse a la base de datos.
      # 'db' es el nombre del servicio de postgres, Docker lo resuelve como el hostname.
      # Se construye dinámicamente usando las variables de PostgreSQL
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-Password#1234}@db:5432/${POSTGRES_DB:-synthetic_data}
      # Variables para Langfuse (opcionales)
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      # Variables para Google Gemini (opcionales)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - MODEL_NAME=${MODEL_NAME:-gemini-2.0-flash-exp}
    # Asegura que el servicio 'db' se inicie antes que el servicio 'app'.
    depends_on:
      - db

# Define el volumen para persistir los datos de la base de datos.
volumes:
  postgres_data: